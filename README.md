# Установка и настройка NTP (chrony)

Скрипт автоматической настройки NTP-сервера с помощью chrony для AlmaLinux, Debian и Ubuntu.

## Возможности

- Установка chrony
- Настройка временной зоны (Europe/Moscow)
- Конфигурирование серверов NTP (ru.pool.ntp.org)
- Открытие порта 123/UDP в firewall (firewalld или ufw)
- Настройка локали времени для Debian/Ubuntu
- Проверка статуса синхронизации

## Использование

Запустите скрипт с помощью `sudo`:

```bash
sudo ./setup_ntp.sh
```

## Основные команды диагностики

- Проверка статуса синхронизации:
    ```bash
    chronyc tracking
    ```

- Список NTP-серверов:
    ```bash
    chronyc sources -v
    chronyc sourcestats -v
    ```

- Принудительная синхронизация:
    ```bash
    chronyc makestep
    ```

## check_ntp_sync.sh — автоматическая проверка и коррекция времени

Скрипт `check_ntp_sync.sh` предназначен для автоматического мониторинга **сильного** расхождения системного времени и его принудительной коррекции при превышении порога.

**Принцип работы:**
- Получает текущее расхождение времени через `chronyc tracking`
- Если расхождение превышает 300 секунд (5 минут), выполняет принудительную синхронизацию (`chronyc makestep`)
- Перезапускает службу `chronyd` для надежности
- Все действия и ошибки логируются в `/var/log/ntp_fix.log`

**Требование:**
- Установленная утилита `bc`, она используется для сравнения вещественных чисел (с плавающей точкой).

**Рекомендации по установке:**
1. Скопируйте скрипт в `/usr/local/bin/` и сделайте исполняемым:
    ```bash
    cp check_ntp_sync.sh /usr/local/bin/
    chmod +x /usr/local/bin/check_ntp_sync.sh
    ```
2. Добавьте запуск в cron для регулярной проверки (например, каждые 5 минут):
    ```bash
    crontab -e
    ```

    ```
    */5 * * * * /usr/local/bin/check_ntp_sync.sh
    ```
3. Запуск скрипта в режиме DEBUG:
    ```bash
    /usr/local/bin/check_ntp_sync.sh --debug
    ```
    или
    ```
    */5 * * * * /usr/local/bin/check_ntp_sync.sh --debug
    ```

**Логирование:**  
Все события записываются в `/var/log/ntp_fix.log` для последующего анализа.

### Настройка logrotate для /var/log/ntp_fix.log на AlmaLinux

Создадим конфигурационный файл для logrotate, который будет управлять лог-файлом нашего скрипта.

1. Создаем файл конфигурации
Создайте новый файл конфигурации в /etc/logrotate.d/:

    ```bash
    sudo tee /etc/logrotate.d/ntp_fix << 'EOF'
    /var/log/ntp_fix.log {
        missingok
        notifempty
        compress
        copytruncate
        daily
        rotate 7
        create 0640 root adm
        dateext
        dateformat -%Y%m%d
    }
    EOF
    ```

2. Объяснение параметров:
    - `missingok` - не выдавать ошибку, если файл отсутствует
    - `notifempty` - не ротировать пустые файлы
    - `compress` - сжимать старые логи с помощью gzip
    - `copytruncate` - копирует файл и затем очищает оригинал (полезно для логов, которые не могут быть переоткрыты)
    - `daily` - ротировать логи ежедневно
    - `rotate 7` - хранить 7 архивных копий
    - `create 0640 root adm` - создавать новый файл с указанными правами и владельцем
    - `dateext` - добавлять дату к имени архивного файла
    - `dateformat -%Y%m%d` - формат даты в имени файла (ГГГГММДД)

3. Проверка конфигурации
Вы можете проверить работу logrotate с вашей конфигурацией:

    ```bash
    sudo logrotate -d /etc/logrotate.d/ntp_fix
    ```
    Флаг `-d` включает режим отладки, показывая что будет сделано без реального выполнения.

4. Принудительный запуск logrotate
Если хотите сразу применить настройки:

    ```bash
    sudo logrotate -f /etc/logrotate.d/ntp_fix
    ```

---